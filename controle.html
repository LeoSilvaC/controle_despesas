<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Gastos - App</title>
    
    <!-- Metadados do PWA / App -->
    <meta name="theme-color" content="#8207e3"/>
    <meta name="description" content="Controle Financeiro Pessoal que funciona como um App."/>
    
    <!-- Metadados Espec√≠ficos do iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Controle">
    
    <!-- √çcone de Exemplo para a Tela de In√≠cio (iOS) -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/8207e3/FFFFFF?text=CF">
    
    <!-- Link para o Manifesto do App (embutido) -->
    <link rel="manifest" href="data:application/json;base64,ewogICAgIm5hbWUiOiAiQ29udHJvbGUgZGUgR2FzdG9zIiwKICAgICJzaG9ydF9uYW1lIjogIkNvbnRyb2xlIiwKICAgICJzdGFydF91cmwiOiAiLz9ob21lPXRydWUiLAogICAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjdjN2Y3IiwKICAgICJ0aGVtZV9jb2xvciI6ICIjODIwN2UzIiwKICAgICJkZXNjcmlwdGlvbiI6ICJHZXJlbmNpYWRvciBmaW5hbmNlaXJvIHBlc3NvYWwiLAogICAgImljb25zIjogWwogICAgICAgIHsKICAgICAgICAgICAgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyLzgyMDdlMy9GRkZGRkY/dGV4dD1DGSIgLAogICAgICAgICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAgICAgICAic2l6ZXMiOiAiMTkyeDE5MiIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby81MTJ4NTEyLzgyMDdlMy9GRkZGRkY/dGV4dD1DGSIgLAogICAgICAgICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAgICAgICAic2l6ZXMiOiAiNTEyeDUxMiIKICAgICAgICB9CiAgICBdCn0K">

    <!-- Carregando Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carregando D3.js para o gr√°fico de pizza -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        /* Configura√ß√µes b√°sicas e fonte */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html, body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }
        body {
            padding-top: env(safe-area-inset-top, 0);
            padding-left: env(safe-area-inset-left, 0);
            padding-right: env(safe-area-inset-right, 0);
        }
        .main-container {
            padding: 1rem;
        }

        /* Cor principal Nubank-like */
        .bg-nubank { background-color: #8207e3; }
        .text-nubank { color: #8207e3; }
        .border-nubank { border-color: #8207e3; }
        .shadow-purple { box-shadow: 0 10px 15px -3px rgba(130, 7, 227, 0.3), 0 4px 6px -2px rgba(130, 7, 227, 0.1); }

        .dashboard-card {
            transition: all 0.3s ease;
            @apply transform;
        }
        .dashboard-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        /* Estilo para a tabela em dispositivos menores */
        @media (max-width: 768px) {
            .table-auto th, .table-auto td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }
        }
        /* Estilo para o cont√™iner do gr√°fico D3 */
        #chart-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .arc text {
            font-size: 10px;
            pointer-events: none;
            fill: white;
            font-weight: bold;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 12px;
            z-index: 100;
        }

        /* Estilos para o Modal de Edi√ß√£o */
        #edit-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
        }
        #edit-modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 201;
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="main-container">

        <div class="max-w-6xl mx-auto p-4 md:p-8 bg-white rounded-xl shadow-lg relative">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">üíæ Controle Financeiro Pessoal</h1>
            <p class="text-gray-500 mb-6">Seus dados s√£o salvos apenas no seu dispositivo.</p>

            <!-- BOT√ÉO DE RESET -->
            <div class="absolute top-4 right-4 md:top-8 md:right-8">
                <button id="reset-data-button" class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm font-semibold shadow hover:bg-red-600 transition duration-150" title="Limpa os dados salvos e recarrega a lista da fatura">
                    Resetar Dados
                </button>
            </div>

            <!-- DASHBOARD RESUMO FINANCEIRO -->
            <div id="dashboard-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <!-- Limite Total -->
                <div class="dashboard-card bg-nubank text-white p-6 rounded-xl shadow-xl shadow-purple">
                    <p class="text-sm opacity-80 font-medium">Limite Total (Nubank)</p>
                    <p id="limit-total" class="text-4xl font-bold mt-1">R$ 0,00</p>
                </div>

                <!-- Fatura Aberta -->
                <div class="dashboard-card bg-white text-gray-800 p-6 rounded-xl shadow-md border-b-4 border-red-500">
                    <p class="text-sm font-medium text-red-600">Fatura Aberta (Valor Parcial)</p>
                    <p id="current-bill" class="text-3xl font-bold mt-1">R$ 0,00</p>
                </div>

                <!-- Cr√©dito Dispon√≠vel -->
                <div class="dashboard-card bg-white text-gray-800 p-6 rounded-xl shadow-md border-b-4 border-green-500">
                    <p class="text-sm font-medium text-green-600">Cr√©dito Dispon√≠vel (Hoje)</p>
                    <p id="available-credit" class="text-3xl font-bold mt-1">R$ 0,00</p>
                </div>
            </div>

            <!-- TOTAL DE COMPROMISSO MENSAL -->
            <div class="mb-10 p-6 bg-purple-50 rounded-xl border-l-4 border-nubank shadow-inner">
                <h2 class="text-xl font-bold text-gray-800 mb-2">‚≠ê Compromisso (Pr√≥ximas Faturas)</h2>
                <p class="text-sm text-gray-600 mb-3">Este √© o valor total de parcelas futuras, que entrar√£o nos seus pr√≥ximos extratos (n√£o inclui a fatura aberta acima).</p>
                <p id="commitment-total" class="text-4xl font-extrabold text-nubank">R$ 0,00</p>
            </div>

            <!-- OR√áAMENTO MENSAL (VIS√ÉO DE CAIXA) -->
            <div class="mb-10 p-6 bg-blue-50 rounded-xl shadow-lg border border-blue-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-2">üí∞ Or√ßamento Mensal (Vis√£o de Caixa)</h2>
                <div class="space-y-4">
                    <!-- ENTRADAS -->
                    <div class="flex justify-between items-center p-2 rounded-lg">
                        <label for="monthly-income" class="text-lg font-medium text-gray-700">Minhas Entradas:</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-500 text-lg">R$</span>
                            <input type="number" id="monthly-income" class="text-lg font-bold text-green-600 w-48 text-right pr-4 pl-10 py-2 border rounded-md shadow-sm focus:border-nubank focus:ring-nubank" placeholder="0.00">
                        </div>
                    </div>
                    
                    <!-- SA√çDA (NUBANK) -->
                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="text-md text-gray-600">Sa√≠das (Fatura Aberta Nubank):</span>
                        <span id="calc-out-nubank" class="text-lg font-bold text-red-600">- R$ 0,00</span>
                    </div>

                    <!-- SA√çDA (OUTROS) -->
                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="text-md text-gray-600">Sa√≠das (Outras Despesas - D√©bito/Dinheiro):</span>
                        <span id="calc-out-others" class="text-lg font-bold text-red-600">- R$ 0,00</span>
                    </div>

                    <!-- SALDO FINAL -->
                    <div class="flex justify-between items-center border-t-2 border-gray-400 pt-4 mt-4">
                        <span class="text-xl font-extrabold text-gray-900">Saldo Final Previsto:</span>
                        <span id="calc-final-balance" class="text-2xl font-extrabold text-blue-700">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <!-- GR√ÅFICO DE PIZZA E ADICIONAR GASTO -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                <!-- GR√ÅFICO -->
                <div class="p-6 bg-gray-50 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Gr√°fico de Distribui√ß√£o por Categoria</h2>
                    <div id="chart-container" class="w-full h-80">
                        <svg id="pie-chart"></svg>
                    </div>
                    <div id="tooltip" class="tooltip"></div>
                </div>

                <!-- FORMUL√ÅRIO PARA NOVO GASTO -->
                <div class="p-6 bg-white rounded-xl shadow-xl border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 text-nubank">‚ûï Adicionar Novo Gasto</h2>
                    <form id="add-expense-form" class="space-y-4">
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">Descri√ß√£o/Item</label>
                            <input type="text" id="description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="value" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                                <input type="number" step="0.01" id="value" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                            </div>
                            <div>
                                <label for="installments" class="block text-sm font-medium text-gray-700">Parcelas (Total)</label>
                                <input type="number" min="1" id="installments" value="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                            </div>
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700">Categoria</label>
                            <select id="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                                <option value="">Selecione a Categoria</option>
                                <option value="Servi√ßos Digitais">Servi√ßos Digitais</option>
                                <option value="Sa√∫de/Bem-Estar">Sa√∫de/Bem-Estar</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Educa√ß√£o">Educa√ß√£o</option>
                                <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                                <option value="Casa/Moradia">Casa/Moradia</option>
                                <option value="Lazer">Lazer</option>
                                <option value="Eletr√¥nicos">Eletr√¥nicos</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label for="payment" class="block text-sm font-medium text-gray-700">Meio de Pagamento</label>
                            <select id="payment" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                                <option value="Nubank">Nubank</option>
                                <option value="Outros">Outros (D√©bito/Dinheiro/Outro Cart√£o)</option>
                            </select>
                        </div>
                        <button type="submit" id="submit-button" class="w-full bg-nubank text-white py-2 rounded-lg font-semibold shadow-md hover:bg-purple-700 transition duration-150">
                            Registrar Gasto
                        </button>
                    </form>
                </div>
            </div>


            <!-- TABELA DE GASTOS -->
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Detalhes de Despesas (Fixas e Parceladas)</h2>
            <div class="overflow-x-auto bg-white rounded-xl shadow-md border">
                <table class="min-w-full divide-y divide-gray-200 table-auto">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Mensal (R$)</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Parcelas</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Restantes</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pagamento</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Linhas da tabela ser√£o inseridas aqui pelo JS -->
                    </tbody>
                </table>
            </div>

            <!-- NOTA IMPORTANTE -->
            <div class="mt-8 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg">
                <p class="font-bold">Nota Importante:</p>
                <p class="text-sm">A "Fatura Aberta" soma o valor de 1 parcela de todos os itens com "Restantes >= 1". O "Compromisso (Pr√≥ximas Faturas)" soma o valor das parcelas *restantes* (ex: 6 restantes = 5 parcelas futuras).</p>
            </div>

        </div> <!-- Fim do max-w-6xl -->

    </div> <!-- Fim do main-container -->

    <!-- MODAL DE EDI√á√ÉO -->
    <div id="edit-modal-backdrop" class="hidden">
        <div id="edit-modal-content" class="p-6 bg-white rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-5 text-nubank">‚úèÔ∏è Editar Gasto</h2>
            <form id="edit-expense-form" class="space-y-4">
                <!-- Campo oculto para o ID -->
                <input type="hidden" id="edit-id">
                
                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-700">Descri√ß√£o/Item</label>
                    <input type="text" id="edit-description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-value" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                        <input type="number" step="0.01" id="edit-value" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                    </div>
                    <div>
                        <label for="edit-category" class="block text-sm font-medium text-gray-700">Categoria</label>
                        <select id="edit-category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                            <!-- Op√ß√µes de categoria (iguais ao outro formul√°rio) -->
                            <option value="Servi√ßos Digitais">Servi√ßos Digitais</option>
                            <option value="Sa√∫de/Bem-Estar">Sa√∫de/Bem-Estar</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Educa√ß√£o">Educa√ß√£o</option>
                            <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                            <option value="Casa/Moradia">Casa/Moradia</option>
                            <option value="Lazer">Lazer</option>
                            <option value="Eletr√¥nicos">Eletr√¥nicos</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-installments" class="block text-sm font-medium text-gray-700">Total Parcelas</label>
                        <input type="number" min="1" id="edit-installments" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                    </div>
                    <div>
                        <label for="edit-remaining" class="block text-sm font-medium text-gray-700">Parcelas Restantes</label>
                        <input type="number" min="0" id="edit-remaining" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                    </div>
                </div>
                
                <div>
                    <label for="edit-payment" class="block text-sm font-medium text-gray-700">Meio de Pagamento</label>
                    <select id="edit-payment" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-nubank focus:ring-nubank">
                        <option value="Nubank">Nubank</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>

                <!-- Bot√µes do Modal -->
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-edit-button" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                    <button type="submit" id="save-edit-button" class="bg-nubank text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-purple-700 transition">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- FIM DO MODAL -->


    <script>
        
        // --- CONSTANTES E VARI√ÅVEIS GLOBAIS ---
        const CREDIT_LIMIT = 3600.00;
        const INCOME_STORAGE_KEY = 'controleGastosIncome';
        const DATA_STORAGE_KEY = 'controleGastosData';
        
        // Vari√°vel global que armazenar√° os dados
        window.expenses = []; 

        // Defini√ß√£o dos gastos iniciais (Seed da Fatura)
        window.getInitialExpenses = () => ([
            // O id 'seed_' garante que o reset funcione corretamente
            // O valor √© o valor da PARCELA MENSAL
            // remaining = 1 (para avulsos) ou (parcelas restantes)
            // installments = 1 (para avulsos) ou (total de parcelas)

            // Servi√ßos Digitais (Recorrentes)
            
        ]);
        
        // --- FUN√á√ïES DE ARMAZENAMENTO LOCAL (localStorage) ---
        function saveExpensesToLocal() {
            // Salva o array de despesas no localStorage
            localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(window.expenses));
            console.log("Dados de gastos salvos no localStorage.");
        }

        function loadExpensesFromLocal() {
            // Carrega o array de despesas do localStorage
            const data = localStorage.getItem(DATA_STORAGE_KEY);
            if (data) {
                window.expenses = JSON.parse(data);
                console.log("Dados de gastos carregados.");
            } else {
                // Se n√£o houver dados, inicializa com os dados de seed (SUA FATURA)
                window.expenses = window.getInitialExpenses();
                saveExpensesToLocal(); // Salva a seed no localStorage
                console.log("Dados inicializados (seed) e salvos.");
            }
        }

        
        // --- FUN√á√ïES DE FORMATO ---
        const formatCurrency = (value) => {
            // Trata valores nulos ou indefinidos
            if (typeof value !== 'number' || isNaN(value)) {
                value = 0;
            }
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        function roundToTwo(num) {
            // Fun√ß√£o auxiliar para evitar problemas de arredondamento em JS
            return +(Math.round(num + "e+2")  + "e-2");
        }
        
        // --- FUN√á√ÉO PRINCIPAL: CALCULAR E RENDERIZAR TUDO ---
        window.updateDashboard = function() {
            // 1. Persiste os dados (salva no localStorage) - **Chamada imediata para garantir salvamento**
            saveExpensesToLocal();

            // 2. (L√ìGICA CORRIGIDA) CALCULA FATURA ATUAL (ABERTA)
            const currentBillTotal = window.expenses
                .filter(exp => exp.payment === 'Nubank' && exp.remaining >= 1)
                .reduce((sum, exp) => sum + (exp.value || 0), 0);

            // 3. (L√ìGICA CORRIGIDA) CALCULA COMPROMISSO FUTURO
            const futureInstallmentsCommitment = window.expenses
                .filter(exp => exp.payment === 'Nubank' && exp.installments > 1 && exp.remaining > 1)
                .reduce((sum, exp) => sum + (exp.value * (exp.remaining - 1)), 0);
            
            // 3.5. CALCULA SA√çDAS (OUTROS)
            const otherExpensesTotal = window.expenses
                .filter(exp => exp.payment === 'Outros' && exp.remaining >= 1)
                .reduce((sum, exp) => sum + (exp.value || 0), 0);

            // 4. (L√ìGICA CORRIGIDA) CALCULA GASTO TOTAL COMPROMETIDO NO CART√ÉO
            const totalCommitted = currentBillTotal + futureInstallmentsCommitment; 
            
            // 5. CALCULA CR√âDITO DISPON√çVEL
            const availableCredit = CREDIT_LIMIT - totalCommitted;

            // 5.5 CALCULA SALDO FINAL (VIS√ÉO DE CAIXA)
            const incomeTotal = parseFloat(document.getElementById('monthly-income').value) || 0;
            const finalBalance = incomeTotal - currentBillTotal - otherExpensesTotal;

            // 6. ATUALIZA O DASHBOARD (DOM)
            document.getElementById('limit-total').textContent = formatCurrency(CREDIT_LIMIT);
            document.getElementById('current-bill').textContent = formatCurrency(currentBillTotal);
            document.getElementById('commitment-total').textContent = formatCurrency(futureInstallmentsCommitment);
            document.getElementById('available-credit').textContent = formatCurrency(availableCredit);

            // Atualiza o bloco de Or√ßamento Mensal
            document.getElementById('calc-out-nubank').textContent = `- ${formatCurrency(currentBillTotal)}`;
            document.getElementById('calc-out-others').textContent = `- ${formatCurrency(otherExpensesTotal)}`;
            
            const finalBalanceEl = document.getElementById('calc-final-balance');
            finalBalanceEl.textContent = formatCurrency(finalBalance);
            // Mudar a cor do saldo final
            finalBalanceEl.classList.remove('text-blue-700', 'text-red-600', 'text-gray-900');
            if (finalBalance < 0) {
                finalBalanceEl.classList.add('text-red-600');
            } else if (finalBalance > 0) {
                finalBalanceEl.classList.add('text-blue-700');
            } else {
                finalBalanceEl.classList.add('text-gray-900');
            }


            // Estilo din√¢mico para o cr√©dito dispon√≠vel
            const availableCreditElement = document.getElementById('available-credit').closest('.dashboard-card');
            
            // Remove classes antigas
            availableCreditElement.classList.remove('border-green-500', 'border-red-500');
            availableCreditElement.querySelector('p:first-child').classList.remove('text-green-600', 'text-red-600');
            document.getElementById('available-credit').classList.remove('text-red-600', 'text-green-600');

            // Adiciona novas classes
            if (availableCredit < 0) {
                availableCreditElement.classList.add('border-red-500');
                availableCreditElement.querySelector('p:first-child').classList.add('text-red-600');
                document.getElementById('available-credit').classList.add('text-red-600');
            } else {
                availableCreditElement.classList.add('border-green-500');
                availableCreditElement.querySelector('p:first-child').classList.add('text-green-600');
                document.getElementById('available-credit').classList.add('text-green-600');
            }
        
            renderTable();
            renderPieChart();
        };
        
        // --- RENDERIZAR TABELA (COM BOT√ïES DE A√á√ÉO) ---
        function renderTable() {
            const tbody = document.getElementById('expenses-table-body');
            tbody.innerHTML = '';
            
            // Ordenar: Nubank primeiro, depois por 'remaining' (maior primeiro)
            const sortedExpenses = [...window.expenses].sort((a, b) => {
                if (a.payment === 'Nubank' && b.payment !== 'Nubank') return -1;
                if (a.payment !== 'Nubank' && b.payment === 'Nubank') return 1;
                return b.remaining - a.remaining; // Mais recentes/ativos primeiro
            });

            sortedExpenses.forEach(exp => {
                const isNubank = exp.payment === 'Nubank';
                const isPaid = exp.remaining === 0;
                const row = tbody.insertRow();
                
                let rowClass = 'hover:bg-gray-100 transition';
                if (isNubank) rowClass = 'bg-purple-50 hover:bg-purple-100 transition';
                if (isPaid) rowClass = 'bg-gray-100 opacity-60 line-through';
                
                row.className = rowClass;

                // Descri√ß√£o
                row.insertCell().textContent = exp.description;
                
                // Categoria
                row.insertCell().textContent = exp.category;
            
                // Valor Mensal
                let valueCell = row.insertCell();
                valueCell.className = 'text-right font-semibold';
                valueCell.textContent = formatCurrency(exp.value);
                
                // Total Parcelas
                let instCell = row.insertCell();
                instCell.className = 'text-center';
                instCell.textContent = exp.installments > 1 ? exp.installments : '-';

                // Restantes
                let remainingText = `${exp.remaining} Restantes`;
                if (exp.installments === 1 && exp.remaining === 1) remainingText = 'Recorrente';
                if (isPaid) remainingText = 'Pago';

                let remCell = row.insertCell();
                remCell.className = 'text-center';
                remCell.textContent = remainingText;
            
                // Pagamento
                let payCell = row.insertCell();
                payCell.className = `text-center font-medium ${isNubank ? 'text-nubank' : 'text-gray-600'}`;
                payCell.textContent = exp.payment;

                // A√ß√µes (Editar e Apagar)
                let actionsCell = row.insertCell();
                actionsCell.className = 'text-center';
                actionsCell.innerHTML = `
                    <button data-id="${exp.id}" class="edit-btn text-blue-600 hover:text-blue-800 p-1" title="Editar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button data-id="${exp.id}" class="delete-btn text-red-600 hover:text-red-800 p-1" title="Apagar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                `;
            });

            // Adiciona os listeners aos novos bot√µes
            attachTableListeners();
        }

        // --- L√ìGICA DO MODAL DE EDI√á√ÉO ---
        const modalBackdrop = document.getElementById('edit-modal-backdrop');
        const modalContent = document.getElementById('edit-modal-content');
        const editForm = document.getElementById('edit-expense-form');
        const cancelEditBtn = document.getElementById('cancel-edit-button');

        function openEditModal(expense) {
            // Preenche o formul√°rio
            document.getElementById('edit-id').value = expense.id;
            document.getElementById('edit-description').value = expense.description;
            document.getElementById('edit-value').value = expense.value;
            document.getElementById('edit-category').value = expense.category;
            document.getElementById('edit-installments').value = expense.installments;
            document.getElementById('edit-remaining').value = expense.remaining;
            document.getElementById('edit-payment').value = expense.payment;
            
            // Mostra o modal
            modalBackdrop.classList.remove('hidden');
        }

        function closeEditModal() {
            modalBackdrop.classList.add('hidden');
            editForm.reset();
        }

        // Salvar Edi√ß√£o
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('edit-id').value;
            const updatedExpense = {
                id: id,
                description: document.getElementById('edit-description').value,
                value: parseFloat(document.getElementById('edit-value').value),
                category: document.getElementById('edit-category').value,
                installments: parseInt(document.getElementById('edit-installments').value),
                remaining: parseInt(document.getElementById('edit-remaining').value),
                payment: document.getElementById('edit-payment').value,
            };

            // Encontra o item no array e o atualiza
            const index = window.expenses.findIndex(exp => exp.id === id);
            if (index !== -1) {
                window.expenses[index] = updatedExpense;
            }

            closeEditModal();
            window.updateDashboard(); // Salva e re-renderiza
        });

        // Cancelar Edi√ß√£o
        cancelEditBtn.addEventListener('click', closeEditModal);
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                closeEditModal();
            }
        });


        // --- ADICIONAR LISTENERS (Bot√µes de Editar/Apagar) ---
        function attachTableListeners() {
            // Bot√µes de Apagar
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    
                    // Filtra o array, removendo o item com o id
                    window.expenses = window.expenses.filter(exp => exp.id !== id);
                    window.updateDashboard(); // Salva e re-renderiza
                });
            });

            // Bot√µes de Editar
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const expenseToEdit = window.expenses.find(exp => exp.id === id);
                    if (expenseToEdit) {
                        openEditModal(expenseToEdit);
                    }
                });
            });
        }
        
        // --- RENDERIZAR GR√ÅFICO DE PIZZA (D3.js) ---
        function renderPieChart() {
            // Remove o gr√°fico e legenda antigos
            d3.select("#chart-container").select("svg").selectAll("*").remove();
            d3.select("#chart-container").select(".legend-container").remove();
            d3.select("#chart-container").select("#no-data").remove();

            // Filtra apenas gastos que est√£o na fatura atual (remaining > 0)
            const expensesForChart = window.expenses.filter(exp => exp.value > 0 && exp.remaining > 0);

            // Agrupa por categoria
            const chartData = d3.group(expensesForChart, d => d.category);
            const totalByCategory = Array.from(chartData, ([key, values]) => ({
                category: key,
                value: d3.sum(values, d => d.value)
            }));
            
            if (totalByCategory.length === 0) {
                d3.select("#chart-container").append("p").attr("id", "no-data").text("Adicione gastos para ver o gr√°fico.");
                return;
            }
        
            const width = 300,
                  height = 300,
                  radius = Math.min(width, height) / 2;
            
            const svg = d3.select("#pie-chart")
                .attr("width", '100%')
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);
            
            // Cores baseadas nas categorias
            const color = d3.scaleOrdinal(d3.schemeCategory10);
            
            const pie = d3.pie()
                .sort(null)
                .value(d => d.value);
            
            const arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius * 0.9);
            
            const arcs = svg.selectAll(".arc")
                .data(pie(totalByCategory))
                .enter().append("g")
                .attr("class", "arc");
            
            const tooltip = d3.select("#tooltip");

            // Define o caminho (fatias do gr√°fico)
            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.category))
                .style("cursor", "pointer")
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`
                        <span class="font-bold">${d.data.category}</span><br/>
                        ${formatCurrency(d.data.value)}
                    `)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
                    d3.select(event.currentTarget).style("opacity", 0.8);
                })
                .on("mouseout", (event, d) => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                    d3.select(event.currentTarget).style("opacity", 1);
                });

            // Adiciona as legendas (texto)
            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("dy", "0.35em")
                .text(d => {
                    const percentage = (d.data.value / d3.sum(totalByCategory, x => x.value)) * 100;
                    return percentage > 5 ? `${Math.round(percentage)}%` : '';
                })
                .style("text-anchor", "middle");

            // Adiciona a Legenda Externa
            const legend = d3.select("#chart-container").append("div")
                .attr("class", "legend-container flex flex-wrap justify-center mt-4 text-sm");

            totalByCategory.sort((a,b) => b.value - a.value).forEach((d, i) => {
                legend.append("div")
                    .attr("class", "flex items-center m-1 p-1 rounded-md bg-gray-100")
                    .html(`
                        <span style="background-color: ${color(d.category)};" class="w-3 h-3 rounded-full inline-block mr-2"></span>
                        ${d.category}: ${formatCurrency(d.value)}
                    `);
            });
        }
        
        // --- ADICIONAR NOVO GASTO ---
        document.getElementById('add-expense-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const description = document.getElementById('description').value;
            const value = parseFloat(document.getElementById('value').value);
            const installments = parseInt(document.getElementById('installments').value);
            const category = document.getElementById('category').value;
            const payment = document.getElementById('payment').value;
            
            if (isNaN(value) || value <= 0) {
                console.warn("Valor inv√°lido inserido.");
                return;
            }

            const submitButton = document.getElementById('submit-button');

            // Habilita loading e desabilita bot√£o
            submitButton.disabled = true;
            submitButton.textContent = 'Calculando...';

            try {
                // Se for 1 parcela (Avulso/Recorrente)
                if (installments === 1) {
                    const expenseData = {
                        id: `local_${Date.now()}_${Math.random().toString(16).slice(2)}`, 
                        description: description,
                        value: value,
                        category: category,
                        payment: payment, 
                        installments: 1,
                        remaining: 1, // Sempre 1 para avulsos
                    };
                    window.expenses.push(expenseData);
                } else {
                    // Se for parcelado
                    const parcelValue = roundToTwo(value / installments);
                    
                    const expenseData = {
                        id: `local_${Date.now()}_${Math.random().toString(16).slice(2)}`, 
                        description: `${description} (1/${installments})`, // Come√ßa na parcela 1
                        value: parcelValue, // Valor da parcela
                        category: category,
                        payment: payment, 
                        installments: installments, // Total
                        remaining: installments, // Restam todas
                    };
                    window.expenses.push(expenseData);
                }

                window.updateDashboard(); // Salva e re-renderiza
                
            } catch (error) {
                console.error("Erro ao processar o gasto:", error);
            } finally {
                // Re-habilita bot√£o
                submitButton.disabled = false;
                submitButton.textContent = 'Registrar Gasto';
                
                // Limpa o formul√°rio
                e.target.reset();
                document.getElementById('installments').value = 1; // Reseta para 1
            }
        });
        
        // --- FUN√á√ïES PARA SALVAR/CARREGAR RENDA ---
        function saveIncomeToLocal(income) {
            localStorage.setItem(INCOME_STORAGE_KEY, income);
            console.log("Renda salva no localStorage.");
        }

        function loadIncomeFromLocal() {
            const income = localStorage.getItem(INCOME_STORAGE_KEY);
            if (income) {
                document.getElementById('monthly-income').value = parseFloat(income);
                console.log("Renda carregada.");
            }
        }

        function handleIncomeChange(e) {
            const income = parseFloat(e.target.value) || 0;
            saveIncomeToLocal(income);
            window.updateDashboard(); 
        }

        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            // --- Listener para o bot√£o de reset ---
            const resetButton = document.getElementById('reset-data-button');
            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    console.log("Limpando dados salvos do localStorage...");
                    resetButton.textContent = 'Limpando...';
                    resetButton.disabled = true;

                    try {
                        localStorage.removeItem(DATA_STORAGE_KEY);
                        localStorage.removeItem(INCOME_STORAGE_KEY);
                        
                        setTimeout(() => {
                            console.log("Recarregando a p√°gina...");
                            window.location.reload();
                        }, 500);

                    } catch (e) {
                        console.error("Erro ao limpar o localStorage:", e);
                        resetButton.textContent = 'Erro ao Resetar';
                    }
                });
            }

            loadIncomeFromLocal(); // Carrega a renda salva
            
            // Adiciona listener para o campo de renda
            document.getElementById('monthly-income').addEventListener('change', handleIncomeChange);
            document.getElementById('monthly-income').addEventListener('keyup', handleIncomeChange);


            loadExpensesFromLocal(); // Carrega os dados salvos localmente
            window.updateDashboard(); // Renderiza a tela


            // --- REGISTRO DO SERVICE WORKER (PWA) ---
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'controle-gastos-cache-v1';
                    const urlsToCache = ['/?home=true'];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => {
                                    console.log('Cache aberto');
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', event => {
                        if (event.request.method !== 'GET' || 
                            event.request.url.includes('cdn.tailwindcss.com') || 
                            event.request.url.includes('d3js.org')) {
                            return;
                        }
                        
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });

                    self.addEventListener('activate', event => {
                        const cacheWhitelist = [CACHE_NAME];
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheWhitelist.indexOf(cacheName) === -1) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });
                `;
                
                try {
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);

                    navigator.serviceWorker.register(swUrl)
                        .then(registration => {
                            console.log('Service Worker registrado com sucesso:', registration);
                        })
                        .catch(error => {
                            console.error('Falha ao registrar o Service Worker:', error);
                        });
                } catch (e) {
                    console.error('Erro ao criar o Blob do Service Worker:', e);
                }
            }
            // --- FIM DO REGISTRO DO SERVICE WORKER ---
        };

    </script>
</body>
</html>